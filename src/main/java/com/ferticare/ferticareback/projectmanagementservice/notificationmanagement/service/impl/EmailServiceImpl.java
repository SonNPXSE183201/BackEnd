package com.ferticare.ferticareback.projectmanagementservice.notificationmanagement.service.impl;

import com.ferticare.ferticareback.projectmanagementservice.notificationmanagement.service.EmailService;
import com.ferticare.ferticareback.projectmanagementservice.usermanagement.entity.User;
import com.ferticare.ferticareback.projectmanagementservice.servicemanagement.entity.TreatmentSchedule;
import com.ferticare.ferticareback.projectmanagementservice.usermanagement.repository.UserRepository;
import com.ferticare.ferticareback.projectmanagementservice.treatmentmanagement.entity.TreatmentPlan;
import jakarta.mail.MessagingException;
import jakarta.mail.internet.MimeMessage;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.mail.javamail.MimeMessageHelper;
import org.springframework.stereotype.Service;
import java.util.Optional;

@Service
public class EmailServiceImpl implements EmailService {

    @Autowired
    private JavaMailSender mailSender;

    @Value("${spring.mail.username}")
    private String from;

    @Autowired
    private UserRepository userRepository;

    @Override
    public void sendVerificationEmail(User user, String token) {
        try {
            String link = "http://localhost:3000/verify-email?token=" + token;

            MimeMessage mimeMessage = mailSender.createMimeMessage();
            MimeMessageHelper helper = new MimeMessageHelper(mimeMessage, true, "UTF-8");

            helper.setFrom(from);
            helper.setTo(user.getEmail());
            helper.setSubject("X√°c th·ª±c Email");

            String htmlContent = "<h2>Xin ch√†o " + user.getFullName() + ",</h2>"
                    + "<p>Vui l√≤ng nh·∫•n v√†o li√™n k·∫øt sau ƒë·ªÉ x√°c th·ª±c ƒë·ªãa ch·ªâ email c·ªßa b·∫°n:</p>"
                    + "<p><a href=\"" + link + "\">X√°c th·ª±c ngay</a></p>"
                    + "<br/><p>Tr√¢n tr·ªçng,<br/>ƒê·ªôi ng≈© FertiCare</p>";

            helper.setText(htmlContent, true); // ‚úÖ true ƒë·ªÉ k√≠ch ho·∫°t HTML

            mailSender.send(mimeMessage);
        } catch (MessagingException e) {
            System.err.println("‚ùå L·ªói khi g·ª≠i email x√°c th·ª±c: " + e.getMessage());
            throw new RuntimeException("ƒêƒÉng k√Ω th·∫•t b·∫°i: Could not parse mail", e);
        }
    }

    @Override
    public void sendPasswordResetEmail(User user, String token) {
        try {
            String link = "http://localhost:3000/reset-password?token=" + token;

            MimeMessage mimeMessage = mailSender.createMimeMessage();
            MimeMessageHelper helper = new MimeMessageHelper(mimeMessage, true, "UTF-8");

            helper.setFrom(from);
            helper.setTo(user.getEmail());
            helper.setSubject("ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u");

            String htmlContent = "<h2>Xin ch√†o " + user.getFullName() + ",</h2>"
                    + "<p>B·∫°n v·ª´a y√™u c·∫ßu ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u. Vui l√≤ng nh·∫•n v√†o li√™n k·∫øt sau ƒë·ªÉ ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u m·ªõi:</p>"
                    + "<p><a href=\"" + link + "\">ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u</a></p>"
                    + "<br/><p>N·∫øu b·∫°n kh√¥ng y√™u c·∫ßu, h√£y b·ªè qua email n√†y.</p>"
                    + "<br/><p>Tr√¢n tr·ªçng,<br/>ƒê·ªôi ng≈© FertiCare</p>";

            helper.setText(htmlContent, true);

            mailSender.send(mimeMessage);
        } catch (MessagingException e) {
            System.err.println("‚ùå L·ªói khi g·ª≠i email ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u: " + e.getMessage());
            throw new RuntimeException("Kh√¥ng th·ªÉ g·ª≠i email ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u", e);
        }
    }

    @Override
    public void sendAppointmentConfirmationEmail(User customer, User doctor, String serviceName, String appointmentDate, String appointmentTime, String room, String notes, String reminderMessage) {
        try {
            MimeMessage mimeMessage = mailSender.createMimeMessage();
            MimeMessageHelper helper = new MimeMessageHelper(mimeMessage, true, "UTF-8");

            helper.setFrom(from);
            helper.setTo(customer.getEmail());
            helper.setSubject("X√°c nh·∫≠n l·ªãch h·∫πn - FertiCare");

            String htmlContent = "<div style='font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;'>"
                    + "<div style='background-color: #4CAF50; color: white; padding: 20px; text-align: center;'>"
                    + "<h1 style='margin: 0;'>FertiCare</h1>"
                    + "<p style='margin: 5px 0 0 0;'>H·ªá th·ªëng chƒÉm s√≥c s·ª©c kh·ªèe sinh s·∫£n</p>"
                    + "</div>"
                    + "<div style='padding: 30px; background-color: #f9f9f9;'>"
                    + "<h2 style='color: #333;'>Xin ch√†o " + customer.getFullName() + ",</h2>"
                    + "<p style='color: #666; font-size: 16px;'>L·ªãch h·∫πn c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n th√†nh c√¥ng!</p>"
                    + "<div style='background-color: white; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #4CAF50;'>"
                    + "<h3 style='color: #333; margin-top: 0;'>üìÖ Th√¥ng tin l·ªãch h·∫πn:</h3>"
                    + "<table style='width: 100%; border-collapse: collapse;'>"
                    + "<tr><td style='padding: 8px 0; font-weight: bold; color: #555;'>D·ªãch v·ª•:</td><td style='padding: 8px 0; color: #333;'>" + serviceName + "</td></tr>"
                    + "<tr><td style='padding: 8px 0; font-weight: bold; color: #555;'>B√°c sƒ©:</td><td style='padding: 8px 0; color: #333;'>" + doctor.getFullName() + "</td></tr>"
                    + "<tr><td style='padding: 8px 0; font-weight: bold; color: #555;'>Ng√†y:</td><td style='padding: 8px 0; color: #333;'>" + appointmentDate + "</td></tr>"
                    + "<tr><td style='padding: 8px 0; font-weight: bold; color: #555;'>Gi·ªù:</td><td style='padding: 8px 0; color: #333;'>" + appointmentTime + "</td></tr>";

            // Th√™m d√≤ng s·ªë ph√≤ng ri√™ng bi·ªát
            if (room != null && !room.isEmpty()) {
                htmlContent += "<tr><td style='padding: 8px 0; font-weight: bold; color: #555;'>S·ªë ph√≤ng:</td><td style='padding: 8px 0; color: #333;'>" + room + "</td></tr>";
            }
            htmlContent += "</table>";

            // Ghi ch√∫ ri√™ng
            if (notes != null && !notes.trim().isEmpty()) {
                htmlContent += "<div style='margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;'>"
                        + "<p style='margin: 0;'><strong>Ghi ch√∫:</strong> " + notes + "</p>"
                        + "</div>";
            }
            // Nh·∫Øc nh·ªü ri√™ng
            if (reminderMessage != null && !reminderMessage.trim().isEmpty()) {
                htmlContent += "<div style='margin-top: 10px;'><span style='color: #e67e22; font-weight: bold;'>" + reminderMessage + "</span></div>";
            }

            htmlContent += "</div>"
                    + "<div style='background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin: 20px 0;'>"
                    + "<h4 style='margin: 0 0 10px 0; color: #856404;'>‚ö†Ô∏è L∆∞u √Ω quan tr·ªçng:</h4>"
                    + "<ul style='margin: 0; padding-left: 20px; color: #856404;'>"
                    + "<li>Vui l√≤ng ƒë·∫øn tr∆∞·ªõc 15 ph√∫t so v·ªõi gi·ªù h·∫πn</li>"
                    + "<li>Mang theo gi·∫•y t·ªù t√πy th√¢n v√† th·∫ª b·∫£o hi·ªÉm (n·∫øu c√≥)</li>"
                    + "<li>N·∫øu c·∫ßn h·ªßy l·ªãch, vui l√≤ng li√™n h·ªá √≠t nh·∫•t 24 gi·ªù tr∆∞·ªõc</li>"
                    + "</ul>"
                    + "</div>"
                    + "<div style='text-align: center; margin-top: 30px;'>"
                    + "<p style='color: #666;'>N·∫øu c√≥ th·∫Øc m·∫Øc, vui l√≤ng li√™n h·ªá:</p>"
                    + "<p style='color: #333; font-weight: bold;'>üìû Hotline: 1900-xxxx</p>"
                    + "<p style='color: #333; font-weight: bold;'>üìß Email: ferticaretreatment@gmail.com</p>"
                    + "</div>"
                    + "<div style='text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;'>"
                    + "<p style='color: #999; font-size: 14px;'>Tr√¢n tr·ªçng,<br/>ƒê·ªôi ng≈© FertiCare</p>"
                    + "</div>"
                    + "</div>"
                    + "</div>";

            helper.setText(htmlContent, true);
            mailSender.send(mimeMessage);
            System.out.println("‚úÖ ƒê√£ g·ª≠i email x√°c nh·∫≠n l·ªãch h·∫πn cho: " + customer.getEmail());
        } catch (MessagingException e) {
            System.err.println("‚ùå L·ªói khi g·ª≠i email x√°c nh·∫≠n l·ªãch h·∫πn: " + e.getMessage());
            // Kh√¥ng throw exception ƒë·ªÉ kh√¥ng ·∫£nh h∆∞·ªüng ƒë·∫øn qu√° tr√¨nh ƒëƒÉng k√Ω l·ªãch
        }
    }

    @Override
    public void sendAppointmentReminder(TreatmentSchedule schedule, int hoursBefore) {
        Optional<User> patientOpt = userRepository.findById(schedule.getPatientId());
        Optional<User> doctorOpt = userRepository.findById(schedule.getDoctorId());
        if (patientOpt.isEmpty()) return;
        User patient = patientOpt.get();
        User doctor = doctorOpt.orElse(null);
        try {
            MimeMessage mimeMessage = mailSender.createMimeMessage();
            MimeMessageHelper helper = new MimeMessageHelper(mimeMessage, true, "UTF-8");
            helper.setFrom(from);
            helper.setTo(patient.getEmail());
            helper.setSubject("[Nh·∫Øc nh·ªü] L·ªãch ƒëi·ªÅu tr·ªã t·∫°i Fertix");
            String htmlContent = "<div style='font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;'>"
                    + "<div style='background: linear-gradient(90deg, #ff6b9d 0%, #ff758c 100%); color: white; padding: 20px; text-align: center; border-radius: 12px 12px 0 0;'>"
                    + "<h1 style='margin: 0;'>Fertix</h1>"
                    + "<p style='margin: 5px 0 0 0;'>H·ªá th·ªëng ƒëi·ªÅu tr·ªã hi·∫øm mu·ªôn v√† chƒÉm s√≥c s·ª©c kh·ªèe sinh s·∫£n</p>"
                    + "</div>"
                    + "<div style='padding: 30px; background-color: #fff6fa;'>"
                    + "<h2 style='color: #ff6b9d;'>Xin ch√†o " + patient.getFullName() + ",</h2>"
                    + "<p style='color: #666; font-size: 16px;'>B·∫°n c√≥ m·ªôt l·ªãch ƒëi·ªÅu tr·ªã s·∫Ω di·ªÖn ra trong <b>" + hoursBefore + " gi·ªù n·ªØa</b>.</p>"
                    + "<div style='background-color: #ffebf2; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ff6b9d;'>"
                    + "<ul style='list-style: none; padding: 0; color: #ff6b9d;'>"
                    + "<li><b>Th·ªùi gian:</b> " + schedule.getScheduledDate() + "</li>"
                    + "<li><b>B∆∞·ªõc ƒëi·ªÅu tr·ªã:</b> " + schedule.getStepName() + "</li>"
                    + (doctor != null ? "<li><b>B√°c sƒ©:</b> " + doctor.getFullName() + "</li>" : "")
                    + (schedule.getRoomId() != null ? "<li><b>Ph√≤ng:</b> " + schedule.getRoomId() + "</li>" : "")
                    + (schedule.getNotes() != null ? "<li><b>Ghi ch√∫:</b> " + schedule.getNotes() + "</li>" : "")
                    + "</ul>"
                    + "</div>"
                    + "<p style='color: #ff6b9d;'>Vui l√≤ng ƒë·∫øn ƒë√∫ng gi·ªù ƒë·ªÉ ƒë·∫£m b·∫£o qu√° tr√¨nh ƒëi·ªÅu tr·ªã di·ªÖn ra thu·∫≠n l·ª£i.</p>"
                    + "<br/><p style='color: #ff758c;'>Tr√¢n tr·ªçng,<br/>ƒê·ªôi ng≈© Fertix</p>"
                    + "</div>"
                    + "</div>";
            helper.setText(htmlContent, true);
            mailSender.send(mimeMessage);
        } catch (MessagingException e) {
            System.err.println("‚ùå L·ªói khi g·ª≠i email nh·∫Øc nh·ªü ƒëi·ªÅu tr·ªã: " + e.getMessage());
        }
    }

    @Override
    public void sendOverdueWarning(TreatmentSchedule schedule) {
        Optional<User> patientOpt = userRepository.findById(schedule.getPatientId());
        if (patientOpt.isEmpty()) return;
        User patient = patientOpt.get();
        try {
            MimeMessage mimeMessage = mailSender.createMimeMessage();
            MimeMessageHelper helper = new MimeMessageHelper(mimeMessage, true, "UTF-8");
            helper.setFrom(from);
            helper.setTo(patient.getEmail());
            helper.setSubject("[C·∫£nh b√°o] B·∫°n ƒë√£ tr·ªÖ l·ªãch ƒëi·ªÅu tr·ªã t·∫°i Fertix");
            String htmlContent = "<div style='font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;'>"
                    + "<div style='background: linear-gradient(90deg, #ff6b9d 0%, #ff758c 100%); color: white; padding: 20px; text-align: center; border-radius: 12px 12px 0 0;'>"
                    + "<h1 style='margin: 0;'>Fertix</h1>"
                    + "<p style='margin: 5px 0 0 0;'>H·ªá th·ªëng ƒëi·ªÅu tr·ªã hi·∫øm mu·ªôn v√† chƒÉm s√≥c s·ª©c kh·ªèe sinh s·∫£n</p>"
                    + "</div>"
                    + "<div style='padding: 30px; background-color: #fff6fa;'>"
                    + "<h2 style='color: #ff6b9d;'>Xin ch√†o " + patient.getFullName() + ",</h2>"
                    + "<p style='color: #ff6b9d; font-size: 16px;'><b>B·∫°n ƒë√£ tr·ªÖ l·ªãch ƒëi·ªÅu tr·ªã h∆°n 30 ph√∫t.</b> Vui l√≤ng li√™n h·ªá ph√≤ng kh√°m ho·∫∑c ƒë·∫øn ngay ƒë·ªÉ kh√¥ng b·ªã h·ªßy k·∫ø ho·∫°ch ƒëi·ªÅu tr·ªã.</p>"
                    + "<div style='background-color: #ffebf2; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ff6b9d;'>"
                    + "<ul style='list-style: none; padding: 0; color: #ff6b9d;'>"
                    + "<li><b>Th·ªùi gian d·ª± ki·∫øn:</b> " + schedule.getScheduledDate() + "</li>"
                    + "<li><b>B∆∞·ªõc ƒëi·ªÅu tr·ªã:</b> " + schedule.getStepName() + "</li>"
                    + "</ul>"
                    + "</div>"
                    + "<br/><p style='color: #ff758c;'>Tr√¢n tr·ªçng,<br/>ƒê·ªôi ng≈© Fertix</p>"
                    + "</div>"
                    + "</div>";
            helper.setText(htmlContent, true);
            mailSender.send(mimeMessage);
        } catch (MessagingException e) {
            System.err.println("‚ùå L·ªói khi g·ª≠i email c·∫£nh b√°o tr·ªÖ l·ªãch: " + e.getMessage());
        }
    }

    @Override
    public void sendTreatmentCancelled(TreatmentSchedule schedule) {
        Optional<User> patientOpt = userRepository.findById(schedule.getPatientId());
        if (patientOpt.isEmpty()) return;
        User patient = patientOpt.get();
        try {
            MimeMessage mimeMessage = mailSender.createMimeMessage();
            MimeMessageHelper helper = new MimeMessageHelper(mimeMessage, true, "UTF-8");
            helper.setFrom(from);
            helper.setTo(patient.getEmail());
            helper.setSubject("[H·ªßy k·∫ø ho·∫°ch] K·∫ø ho·∫°ch ƒëi·ªÅu tr·ªã c·ªßa b·∫°n ƒë√£ b·ªã h·ªßy t·∫°i Fertix");
            String htmlContent = "<div style='font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;'>"
                    + "<div style='background: linear-gradient(90deg, #ff6b9d 0%, #ff758c 100%); color: white; padding: 20px; text-align: center; border-radius: 12px 12px 0 0;'>"
                    + "<h1 style='margin: 0;'>Fertix</h1>"
                    + "<p style='margin: 5px 0 0 0;'>H·ªá th·ªëng ƒëi·ªÅu tr·ªã hi·∫øm mu·ªôn v√† chƒÉm s√≥c s·ª©c kh·ªèe sinh s·∫£n</p>"
                    + "</div>"
                    + "<div style='padding: 30px; background-color: #fff6fa;'>"
                    + "<h2 style='color: #ff6b9d;'>Xin ch√†o " + patient.getFullName() + ",</h2>"
                    + "<p style='color: #ff6b9d; font-size: 16px;'><b>K·∫ø ho·∫°ch ƒëi·ªÅu tr·ªã c·ªßa b·∫°n ƒë√£ b·ªã h·ªßy do kh√¥ng ƒë·∫øn ƒë√∫ng gi·ªù theo quy ƒë·ªãnh.</b></p>"
                    + "<div style='background-color: #ffebf2; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ff6b9d;'>"
                    + "<ul style='list-style: none; padding: 0; color: #ff6b9d;'>"
                    + "<li><b>B∆∞·ªõc ƒëi·ªÅu tr·ªã:</b> " + schedule.getStepName() + "</li>"
                    + "<li><b>Th·ªùi gian d·ª± ki·∫øn:</b> " + schedule.getScheduledDate() + "</li>"
                    + "</ul>"
                    + "</div>"
                    + "<p style='color: #ff6b9d;'>N·∫øu c√≥ th·∫Øc m·∫Øc, vui l√≤ng li√™n h·ªá ph√≤ng kh√°m ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£.</p>"
                    + "<br/><p style='color: #ff758c;'>Tr√¢n tr·ªçng,<br/>ƒê·ªôi ng≈© Fertix</p>"
                    + "</div>"
                    + "</div>";
            helper.setText(htmlContent, true);
            mailSender.send(mimeMessage);
        } catch (MessagingException e) {
            System.err.println("‚ùå L·ªói khi g·ª≠i email h·ªßy k·∫ø ho·∫°ch ƒëi·ªÅu tr·ªã: " + e.getMessage());
        }
    }

    @Override
    public void sendTreatmentCompletionEmail(User patient, User doctor, TreatmentPlan plan) {
        try {
            MimeMessage mimeMessage = mailSender.createMimeMessage();
            MimeMessageHelper helper = new MimeMessageHelper(mimeMessage, true, "UTF-8");
            helper.setFrom(from);
            helper.setTo(patient.getEmail());
            helper.setSubject("[Ho√†n th√†nh] K·∫ø ho·∫°ch ƒëi·ªÅu tr·ªã t·∫°i Fertix");

            String htmlContent = "<div style='font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;'>"
                    + "<div style='background: linear-gradient(90deg, #ff6b9d 0%, #ff758c 100%); color: white; padding: 20px; text-align: center; border-radius: 12px 12px 0 0;'>"
                    + "<h1 style='margin: 0;'>Fertix</h1>"
                    + "<p style='margin: 5px 0 0 0;'>H·ªá th·ªëng ƒëi·ªÅu tr·ªã hi·∫øm mu·ªôn v√† chƒÉm s√≥c s·ª©c kh·ªèe sinh s·∫£n</p>"
                    + "</div>"
                    + "<div style='padding: 30px; background-color: #fff6fa;'>"
                    + "<h2 style='color: #ff6b9d;'>Xin ch√†o " + patient.getFullName() + ",</h2>"
                    + "<p style='color: #666; font-size: 16px;'>Ch√∫c m·ª´ng! K·∫ø ho·∫°ch ƒëi·ªÅu tr·ªã c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c ho√†n th√†nh th√†nh c√¥ng!</p>"
                    + "<div style='background-color: #ffebf2; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ff6b9d;'>"
                    + "<h3 style='color: #ff6b9d; margin-top: 0;'>üéâ Th√¥ng tin ho√†n th√†nh:</h3>"
                    + "<table style='width: 100%; border-collapse: collapse;'>"
                    + "<tr><td style='padding: 8px 0; font-weight: bold; color: #555;'>K·∫ø ho·∫°ch:</td><td style='padding: 8px 0; color: #333;'>" + plan.getPlanName() + "</td></tr>"
                    + "<tr><td style='padding: 8px 0; font-weight: bold; color: #555;'>Lo·∫°i ƒëi·ªÅu tr·ªã:</td><td style='padding: 8px 0; color: #333;'>" + plan.getTreatmentType() + "</td></tr>"
                    + (doctor != null ? "<tr><td style='padding: 8px 0; font-weight: bold; color: #555;'>B√°c sƒ©:</td><td style='padding: 8px 0; color: #333;'>" + doctor.getFullName() + "</td></tr>" : "")
                    + "<tr><td style='padding: 8px 0; font-weight: bold; color: #555;'>Ng√†y b·∫Øt ƒë·∫ßu:</td><td style='padding: 8px 0; color: #333;'>" + plan.getStartDate() + "</td></tr>"
                    + "<tr><td style='padding: 8px 0; font-weight: bold; color: #555;'>Ng√†y ho√†n th√†nh:</td><td style='padding: 8px 0; color: #333;'>" + plan.getEndDate() + "</td></tr>"
                    + "</table>"
                    + "</div>"
                    + "<div style='background-color: #fff3e0; border: 1px solid #ffcc02; padding: 15px; border-radius: 5px; margin: 20px 0;'>"
                    + "<h4 style='margin: 0 0 10px 0; color: #e65100;'>‚úÖ L·ªùi khuy√™n sau ƒëi·ªÅu tr·ªã:</h4>"
                    + "<ul style='margin: 0; padding-left: 20px; color: #e65100;'>"
                    + "<li>Ti·∫øp t·ª•c theo d√µi s·ª©c kh·ªèe theo h∆∞·ªõng d·∫´n c·ªßa b√°c sƒ©</li>"
                    + "<li>Duy tr√¨ l·ªëi s·ªëng l√†nh m·∫°nh v√† ch·∫ø ƒë·ªô ƒÉn u·ªëng h·ª£p l√Ω</li>"
                    + "<li>T√°i kh√°m ƒë·ªãnh k·ª≥ theo l·ªãch h·∫πn</li>"
                    + "<li>Li√™n h·ªá ngay n·∫øu c√≥ d·∫•u hi·ªáu b·∫•t th∆∞·ªùng</li>"
                    + "</ul>"
                    + "</div>"
                    + "<div style='text-align: center; margin-top: 30px;'>"
                    + "<p style='color: #666;'>N·∫øu c√≥ th·∫Øc m·∫Øc, vui l√≤ng li√™n h·ªá:</p>"
                    + "<p style='color: #333; font-weight: bold;'>üìû Hotline: 1900-xxxx</p>"
                    + "<p style='color: #333; font-weight: bold;'>üìß Email: ferticaretreatment@gmail.com</p>"
                    + "</div>"
                    + "<div style='text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;'>"
                    + "<p style='color: #999; font-size: 14px;'>Tr√¢n tr·ªçng,<br/>ƒê·ªôi ng≈© Fertix</p>"
                    + "</div>"
                    + "</div>"
                    + "</div>";
            helper.setText(htmlContent, true);
            mailSender.send(mimeMessage);
            System.out.println("‚úÖ ƒê√£ g·ª≠i email ho√†n th√†nh ƒëi·ªÅu tr·ªã cho: " + patient.getEmail());
        } catch (MessagingException e) {
            System.err.println("‚ùå L·ªói khi g·ª≠i email ho√†n th√†nh ƒëi·ªÅu tr·ªã: " + e.getMessage());
        }
    }

    @Override
    public void sendTreatmentPhasesEmail(User patient, User doctor, TreatmentPlan plan) {
        try {
            MimeMessage mimeMessage = mailSender.createMimeMessage();
            MimeMessageHelper helper = new MimeMessageHelper(mimeMessage, true, "UTF-8");
            helper.setFrom(from);
            helper.setTo(patient.getEmail());
            helper.setSubject("[K·∫ø ho·∫°ch ƒëi·ªÅu tr·ªã] Fertix");

            String htmlContent = "<div style='font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;'>"
                    + "<div style='background: linear-gradient(90deg, #ff6b9d 0%, #ff758c 100%); color: white; padding: 20px; text-align: center; border-radius: 12px 12px 0 0;'>"
                    + "<h1 style='margin: 0;'>Fertix</h1>"
                    + "<p style='margin: 5px 0 0 0;'>H·ªá th·ªëng ƒëi·ªÅu tr·ªã hi·∫øm mu·ªôn v√† chƒÉm s√≥c s·ª©c kh·ªèe sinh s·∫£n</p>"
                    + "</div>"
                    + "<div style='padding: 30px; background-color: #fff6fa;'>"
                    + "<h2 style='color: #ff6b9d;'>Xin ch√†o " + patient.getFullName() + ",</h2>"
                    + "<p style='color: #ff6b9d; font-size: 16px;'>K·∫ø ho·∫°ch ƒëi·ªÅu tr·ªã c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!</p>"
                    + "<div style='background-color: #ffe3ed; border: 1.5px solid #ff6b9d; border-radius: 8px; padding: 20px; margin: 20px 0;'>"
                    + "<h3 style='color: #ff6b9d; margin-top: 0; font-weight: bold;'>üìã Th√¥ng tin k·∫ø ho·∫°ch:</h3>"
                    + "<table style='width: 100%; color: #ff6b9d;'>"
                    + "<tr><td style='font-weight: bold;'>K·∫ø ho·∫°ch:</td><td>" + plan.getPlanName() + "</td></tr>"
                    + "<tr><td style='font-weight: bold;'>Lo·∫°i ƒëi·ªÅu tr·ªã:</td><td>" + plan.getTreatmentType() + "</td></tr>"
                    + (doctor != null ? "<tr><td style='font-weight: bold;'>B√°c sƒ©:</td><td>" + doctor.getFullName() + "</td></tr>" : "")
                    + "<tr><td style='font-weight: bold;'>Ng√†y b·∫Øt ƒë·∫ßu:</td><td>" + plan.getStartDate() + "</td></tr>"
                    + "<tr><td style='font-weight: bold;'>Th·ªùi gian d·ª± ki·∫øn:</td><td>" + plan.getEstimatedDurationDays() + " ng√†y</td></tr>"
                    + "</table>"
                    + "</div>"
                    + "<div style='background-color: #ffe3ed; border: 1.5px solid #ff6b9d; border-radius: 8px; padding: 20px; margin: 20px 0;'>"
                    + "<h3 style='color: #ff6b9d; margin-top: 0; font-weight: bold;'>üóÇÔ∏è C√°c b∆∞·ªõc ti·∫øp theo:</h3>"
                    + "<ul style='color: #ff6b9d; margin: 0; padding-left: 20px;'>"
                    + "<li>B·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o v·ªÅ l·ªãch h·∫πn c·ª• th·ªÉ cho t·ª´ng giai ƒëo·∫°n</li>"
                    + "<li>Vui l√≤ng ƒë·∫øn ƒë√∫ng gi·ªù theo l·ªãch h·∫πn</li>"
                    + "<li>Mang theo gi·∫•y t·ªù t√πy th√¢n v√† th·∫ª b·∫£o hi·ªÉm (n·∫øu c√≥)</li>"
                    + "<li>Li√™n h·ªá ngay n·∫øu c√≥ thay ƒë·ªïi v·ªÅ l·ªãch tr√¨nh</li>"
                    + "</ul>"
                    + "</div>"
                    + "<div style='text-align: center; margin-top: 30px;'>"
                    + "<p style='color: #ff758c;'>N·∫øu c√≥ th·∫Øc m·∫Øc, vui l√≤ng li√™n h·ªá:</p>"
                    + "<p style='color: #ff6b9d; font-weight: bold;'>üìû Hotline: 1900-xxxx</p>"
                    + "<p style='color: #ff6b9d; font-weight: bold;'>üìß Email: ferticaretreatment@gmail.com</p>"
                    + "</div>"
                    + "<div style='text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #ffe3ed;'>"
                    + "<p style='color: #ff758c; font-size: 14px;'>Tr√¢n tr·ªçng,<br/>ƒê·ªôi ng≈© Fertix</p>"
                    + "</div>"
                    + "</div>";
            helper.setText(htmlContent, true);
            mailSender.send(mimeMessage);
            System.out.println("‚úÖ ƒê√£ g·ª≠i email k·∫ø ho·∫°ch ƒëi·ªÅu tr·ªã cho: " + patient.getEmail());
        } catch (MessagingException e) {
            System.err.println("‚ùå L·ªói khi g·ª≠i email k·∫ø ho·∫°ch ƒëi·ªÅu tr·ªã: " + e.getMessage());
        }
    }

    @Override
    public void sendScheduleNotification(User patient, User doctor, TreatmentSchedule schedule) {
        try {
            MimeMessage mimeMessage = mailSender.createMimeMessage();
            MimeMessageHelper helper = new MimeMessageHelper(mimeMessage, true, "UTF-8");
            helper.setFrom(from);
            helper.setTo(patient.getEmail());
            helper.setSubject("[L·ªãch h·∫πn ƒëi·ªÅu tr·ªã] FertiCare - " + schedule.getStepName());

            String htmlContent = "<div style='font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;'>"
                    + "<div style='background-color: #FF9800; color: white; padding: 20px; text-align: center;'>"
                    + "<h1 style='margin: 0;'>FertiCare</h1>"
                    + "<p style='margin: 5px 0 0 0;'>H·ªá th·ªëng chƒÉm s√≥c s·ª©c kh·ªèe sinh s·∫£n</p>"
                    + "</div>"
                    + "<div style='padding: 30px; background-color: #f9f9f9;'>"
                    + "<h2 style='color: #333;'>Xin ch√†o " + patient.getFullName() + ",</h2>"
                    + "<p style='color: #666; font-size: 16px;'>L·ªãch h·∫πn ƒëi·ªÅu tr·ªã c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c s·∫Øp x·∫øp!</p>"
                    + "<div style='background-color: white; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #FF9800;'>"
                    + "<h3 style='color: #333; margin-top: 0;'>üìÖ Th√¥ng tin l·ªãch h·∫πn:</h3>"
                    + "<table style='width: 100%; border-collapse: collapse;'>"
                    + "<tr><td style='padding: 8px 0; font-weight: bold; color: #555;'>B∆∞·ªõc ƒëi·ªÅu tr·ªã:</td><td style='padding: 8px 0; color: #333;'>" + schedule.getStepName() + "</td></tr>"
                    + "<tr><td style='padding: 8px 0; font-weight: bold; color: #555;'>Th·ª© t·ª±:</td><td style='padding: 8px 0; color: #333;'>B∆∞·ªõc " + schedule.getStepNumber() + "</td></tr>"
                    + "<tr><td style='padding: 8px 0; font-weight: bold; color: #555;'>Th·ªùi gian:</td><td style='padding: 8px 0; color: #333;'>" + schedule.getScheduledDate() + "</td></tr>"
                    + "<tr><td style='padding: 8px 0; font-weight: bold; color: #555;'>Ph√≤ng:</td><td style='padding: 8px 0; color: #333;'>" + schedule.getRoomId() + "</td></tr>"
                    + (doctor != null ? "<tr><td style='padding: 8px 0; font-weight: bold; color: #555;'>B√°c sƒ©:</td><td style='padding: 8px 0; color: #333;'>" + doctor.getFullName() + "</td></tr>" : "")
                    + "<tr><td style='padding: 8px 0; font-weight: bold; color: #555;'>Lo·∫°i ƒëi·ªÅu tr·ªã:</td><td style='padding: 8px 0; color: #333;'>" + schedule.getTreatmentType() + "</td></tr>"
                    + (schedule.getNotes() != null ? "<tr><td style='padding: 8px 0; font-weight: bold; color: #555;'>Ghi ch√∫:</td><td style='padding: 8px 0; color: #333;'>" + schedule.getNotes() + "</td></tr>" : "")
                    + "</table>"
                    + "</div>"
                    + "<div style='background-color: #fff3e0; border: 1px solid #ffcc02; padding: 15px; border-radius: 5px; margin: 20px 0;'>"
                    + "<h4 style='margin: 0 0 10px 0; color: #e65100;'>‚ö†Ô∏è L∆∞u √Ω quan tr·ªçng:</h4>"
                    + "<ul style='margin: 0; padding-left: 20px; color: #e65100;'>"
                    + "<li>Vui l√≤ng ƒë·∫øn tr∆∞·ªõc 15 ph√∫t so v·ªõi gi·ªù h·∫πn</li>"
                    + "<li>Mang theo gi·∫•y t·ªù t√πy th√¢n v√† th·∫ª b·∫£o hi·ªÉm (n·∫øu c√≥)</li>"
                    + "<li>Nh·ªãn ƒÉn theo h∆∞·ªõng d·∫´n c·ªßa b√°c sƒ© (n·∫øu c·∫ßn)</li>"
                    + "<li>Li√™n h·ªá ngay n·∫øu kh√¥ng th·ªÉ ƒë·∫øn ƒë√∫ng gi·ªù</li>"
                    + "</ul>"
                    + "</div>"
                    + "<div style='text-align: center; margin-top: 30px;'>"
                    + "<p style='color: #666;'>N·∫øu c√≥ th·∫Øc m·∫Øc, vui l√≤ng li√™n h·ªá:</p>"
                    + "<p style='color: #333; font-weight: bold;'>üìû Hotline: 1900-xxxx</p>"
                    + "<p style='color: #333; font-weight: bold;'>üìß Email: ferticaretreatment@gmail.com</p>"
                    + "</div>"
                    + "<div style='text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;'>"
                    + "<p style='color: #999; font-size: 14px;'>Tr√¢n tr·ªçng,<br/>ƒê·ªôi ng≈© FertiCare</p>"
                    + "</div>"
                    + "</div>"
                    + "</div>";

            helper.setText(htmlContent, true);
            mailSender.send(mimeMessage);
            System.out.println("‚úÖ ƒê√£ g·ª≠i email th√¥ng b√°o l·ªãch h·∫πn cho: " + patient.getEmail());
        } catch (MessagingException e) {
            System.err.println("‚ùå L·ªói khi g·ª≠i email th√¥ng b√°o l·ªãch h·∫πn: " + e.getMessage());
        }
    }
} 